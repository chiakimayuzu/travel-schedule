{% extends "base.html" %}

{% block content %}
  <h1>旅行プラン詳細</h1>

  <div>
    <h2>プラン名: {{ plan.touristplan_name }}</h2>
    <p><strong>開始日:</strong> {{ plan.start_date }}</p>
    <p><strong>終了日:</strong> {{ plan.end_date }}</p>

    <h3>訪問予定日と観光スポット</h3>
    <table class="table table-bordered">
      <thead>
        <tr>
          <th>訪問日</th>
          <th>観光スポット</th>
        </tr>
      </thead>
      <tbody>
        {% for visit in visit_date %}
          {% with modal_counter=forloop.counter %}
            <tr>
              <td>{{ visit }}</td>
              <td>
                <ul id="selectedSpot{{ modal_counter }}" class="selected-spot sortable">
                  {% for spot in selected_spots %}
                    {% if spot.visit_date == visit %}
                      <li class="sortable-item" data-spot-name="{{ spot.spot_name }}">
                        <strong>{{ spot.spot_name }}</strong>
                        {% if spot.picture %}
                          <img src="{{ spot.picture }}" alt="{{ spot.spot_name }}" style="width:100px; height:auto;"><br>
                        {% endif %}
                        都道府県: {{ spot.prefecture }}<br>
                        住所: {{ spot.address }}<br>
                        平均滞在時間: {{ spot.staytime_hours }}時間{{ spot.staytime_minutes }}分
                        <span class="drag-handle">↕️</span>
                      </li>
                    {% endif %}
                  {% endfor %}
                </ul>
                <br>
                <a href="#" class="openWantedSpotModal" data-modal-id="wantedSpotModal{{ modal_counter }}" data-target-id="selectedSpot{{ modal_counter }}">
                  行きたいリストから選択
                </a>
              </td>
            </tr>

            <div id="wantedSpotModal{{ modal_counter }}" class="modal">
              <div class="modal-content">
                <span class="close" onclick="closeModal()">&times;</span>
                <h2>行きたいリストから選択</h2>
                {% if wanted_spots %}
                  <ul>
                    {% for spot in wanted_spots %}
                      <li>
                        <input type="checkbox" class="wanted-checkbox"
                               data-spot-name="{{ spot.spot_name }}"
                               data-picture="{{ spot.picture }}"
                               data-category="{{ spot.category }}"
                               data-prefecture="{{ spot.prefecture }}"
                               data-address="{{ spot.address }}"
                               data-staytime-hours="{{ spot.staytime_hours }}"
                               data-staytime-minutes="{{ spot.staytime_minutes }}"
                               {% if spot.spot_name in selected_spot_names %} checked {% endif %}>
                        <strong>{{ spot.spot_name }}</strong><br>
                        {% if spot.picture %}
                          <img src="{{ spot.picture }}" alt="{{ spot.spot_name }}" style="width: 100px; height: auto;"><br>
                        {% endif %}
                        カテゴリ: {{ spot.category }}<br>
                        都道府県: {{ spot.prefecture }}<br>
                        住所: {{ spot.address }}<br>
                        平均滞在時間: {{ spot.staytime_hours }}時間{{ spot.staytime_minutes }}分
                      </li>
                    {% endfor %}
                  </ul>
                  <button type="button" class="btn btn-success confirmSelection">選択完了</button>
                {% else %}
                  <p>行きたいリストはありません。</p>
                {% endif %}
              </div>
            </div>
          {% endwith %}
        {% endfor %}
      </tbody>
    </table>

    <a href="{% url 'travelapp:touristplan_list' %}" class="btn btn-secondary">旅行プラン一覧に戻る</a>
  </div>

  <script>
    document.querySelectorAll('.openWantedSpotModal').forEach(function (link) {
      link.addEventListener('click', function (e) {
        e.preventDefault();
        currentTargetId = this.getAttribute('data-target-id');
        var modalId = this.getAttribute('data-modal-id');
        openModal(modalId);
      });
    });

    document.querySelectorAll('.confirmSelection').forEach(function (button) {
      button.addEventListener('click', function () {
        var modal = this.closest('.modal');
        var checkedItems = modal.querySelectorAll('.wanted-checkbox:checked');

        var selectedList = document.getElementById(currentTargetId);
        selectedList.innerHTML = "";

        checkedItems.forEach(function (checkbox) {
          var spotName = checkbox.getAttribute('data-spot-name');
          var listItem = document.createElement("li");
          listItem.textContent = spotName;
          listItem.classList.add("sortable-item");
          listItem.setAttribute("data-spot-name", spotName);

          var dragHandle = document.createElement("span");
          dragHandle.textContent = "↕️";
          dragHandle.classList.add("drag-handle");
          listItem.appendChild(dragHandle);

          selectedList.appendChild(listItem);
        });

        closeModal();
        new Sortable(selectedList, { handle: ".drag-handle", animation: 150 });
      });
    });

    function openModal(modalId) {
      document.getElementById(modalId).style.display = 'block';
    }

    function closeModal() {
      document.querySelectorAll('.modal').forEach(modal => modal.style.display = 'none');
    }
  </script>

  <style>
    .sortable { list-style: none; padding: 0; }
    .sortable-item { display: flex; align-items: center; padding: 5px; border: 1px solid #ddd; margin: 5px 0; background: #f9f9f9; cursor: grab; }
    .drag-handle { margin-left: auto; cursor: grab; }
    .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.4); }
    .modal-content { background-color: #fff; margin: 15% auto; padding: 20px; width: 80%; max-width: 500px; border-radius: 4px; }
    .close { position: absolute; top: 10px; right: 10px; font-size: 28px; cursor: pointer; }
  </style>
{% endblock %}