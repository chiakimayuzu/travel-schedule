{% extends "base.html" %}

{% block content %}
  <h1>旅行プラン詳細</h1>

  <div>
    <h2>プラン名: {{ plan.touristplan_name }}</h2>
    <p><strong>開始日:</strong> {{ plan.start_date }}</p>
    <p><strong>終了日:</strong> {{ plan.end_date }}</p>

    <h3>訪問予定日と観光スポット</h3>
    <table class="table table-bordered">
      <thead>
        <tr>
          <th>訪問日</th>
          <th>観光スポット</th>
        </tr>
      </thead>
      <tbody>
        {% for visit in visit_date %}
          {% with modal_counter=forloop.counter %}
            <tr>
              <td>{{ visit }}</td>
              <td>
                <!-- 選択済みの観光地をプレーンテキストで表示 -->
                <span id="selectedSpot{{ modal_counter }}" class="selected-spot">
                  {% for spot in plan.tourist_spots.all %}
                    {% if spot.visit_date == visit %}
                      {{ spot.tourist_spot.spot_name }}
                    {% endif %}
                  {% endfor %}
                </span>
                <br>
                <!-- モーダルを開くリンク（data-target-idで対象のspanを指定） -->
                <a href="#"
                   class="openWantedSpotModal"
                   data-modal-id="wantedSpotModal{{ modal_counter }}"
                   data-target-id="selectedSpot{{ modal_counter }}">
                  行きたいリストから選択
                </a>
              </td>
            </tr>

            <!-- 訪問日に対応するモーダル -->
            <div id="wantedSpotModal{{ modal_counter }}" class="modal">
              <div class="modal-content">
                <span class="close" onclick="closeModal()">&times;</span>
                <h2>行きたいリストから選択</h2>
                {% if wanted_spots %}
                  <ul>
                    {% for wanted in wanted_spots %}
                      <li>
                        <input type="checkbox" class="wanted-checkbox" data-spot-name="{{ wanted.tourist_spot.spot_name }}" 
                               data-spot-picture="{{ wanted.tourist_spot.picture.url }}" 
                               data-spot-category="{{ wanted.tourist_spot.get_category_display }}" 
                               data-spot-prefecture="{{ wanted.tourist_spot.get_prefecture_display }}" 
                               data-spot-address="{{ wanted.tourist_spot.address }}" 
                               data-spot-staytime="{{ wanted.tourist_spot.staytime_average }}">
                        {{ wanted.tourist_spot.spot_name }}
                        <div>
                          <img src="{{ wanted.tourist_spot.picture.url }}" alt="Tourist Spot Image" width="100">
                          <p>カテゴリ: {{ wanted.tourist_spot.get_category_display }}</p>
                          <p>都道府県: {{ wanted.tourist_spot.get_prefecture_display }}</p>
                          <p>住所: {{ wanted.tourist_spot.address }}</p>
                          <p>平均滞在時間: {{ wanted.tourist_spot.staytime_average }} 分</p>
                        </div>
                      </li>
                    {% endfor %}
                  </ul>
                  <button type="button" class="btn btn-success confirmSelection">選択完了</button>
                {% else %}
                  <p>行きたいリストはありません。</p>
                {% endif %}
              </div>
            </div>
          {% endwith %}
        {% endfor %}
      </tbody>
    </table>

    <a href="{% url 'travelapp:touristplan_list' %}" class="btn btn-secondary">旅行プラン一覧に戻る</a>
  </div>

  <!-- モーダルのスタイル -->
  <style>
    .modal {
      display: none;               /* 初期状態は非表示 */
      position: fixed;             /* 画面全体に固定 */
      z-index: 100;                /* 他の要素より前面に表示 */
      left: 0;
      top: 0;
      width: 100%;                 /* 画面全体の幅 */
      height: 100%;                /* 画面全体の高さ */
      overflow: auto;              /* 必要に応じてスクロール */
      background-color: rgba(0,0,0,0.4);  /* 半透明の背景 */
    }
    .modal-content {
      position: relative;          /* 絶対配置の閉じるボタンの基準にする */
      background-color: #fefefe;
      margin: 15% auto;            /* 上から15%の位置に配置し、中央に水平寄せ */
      padding: 20px;
      border: 1px solid #888;
      width: 80%;                  /* 幅はお好みで調整 */
      max-width: 500px;            /* 最大幅を設定して中央寄せを維持 */
      box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2);
      border-radius: 4px;
    }
    .close {
      position: absolute;          /* 絶対配置 */
      top: 10px;                   /* 上からの余白 */
      right: 10px;                 /* 右からの余白 */
      color: #aaa;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }
    .close:hover,
    .close:focus {
      color: black;
      text-decoration: none;
    }
  </style>

  <!-- JavaScript -->
  <script>
    // 現在開かれているモーダルの対象spanのIDを保持するための変数
    var currentTargetId = null;

    function openModal(modalId) {
      var modalElement = document.getElementById(modalId);
      if (modalElement) {
        modalElement.style.display = 'block';
      } else {
        console.log("Modal element not found: " + modalId);
      }
    }
    
    function closeModal() {
      var modals = document.querySelectorAll('.modal');
      modals.forEach(function(modal) {
        modal.style.display = 'none';
      });
      // チェック状態を全てリセット（オプション）
      document.querySelectorAll('.wanted-checkbox').forEach(function(checkbox) {
        checkbox.checked = false;
      });
    }
    
    // リンククリック時、対象のspanのIDをグローバル変数に格納し、モーダルを開く
    document.querySelectorAll('.openWantedSpotModal').forEach(function(link) {
      link.addEventListener('click', function(e) {
        e.preventDefault(); // リンクのデフォルト動作を防ぐ
        currentTargetId = this.getAttribute('data-target-id');
        var modalId = this.getAttribute('data-modal-id');
        openModal(modalId);
      });
    });
    
    // 「選択完了」ボタン押下時の処理
    document.querySelectorAll('.confirmSelection').forEach(function(button) {
      button.addEventListener('click', function() {
        // 現在のモーダル内のチェックされた項目を取得
        var modal = this.closest('.modal');
        var checkedItems = modal.querySelectorAll('.wanted-checkbox:checked');
        var selectedNames = [];
        checkedItems.forEach(function(checkbox) {
          selectedNames.push(checkbox.getAttribute('data-spot-name'));
        });
        // 対象のspanに選択された複数の名前をカンマ区切りで設定
        if (currentTargetId) {
          document.getElementById(currentTargetId).textContent = selectedNames.join(', ');
        }
        closeModal();
      });
    });
  </script>

{% endblock %}