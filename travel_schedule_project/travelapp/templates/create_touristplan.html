{% extends "base.html" %}

{% block content %}
  <h1>æ—…è¡Œãƒ—ãƒ©ãƒ³ä½œæˆ</h1>
  <form method="post">
    {% csrf_token %}
    {{ form.as_p }}

    <!-- æ—¥ä»˜ã®é¸æŠ -->
    <div id="calendar">
      <label for="dates">æ—…è¡Œæ—¥ç¨‹é¸æŠï¼ˆæœ€å¤§5æ—¥é–“ï¼‰</label>
      <!-- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã‚‹ -->
      <span id="calendar-icon" style="cursor:pointer;">ğŸ“…</span>
      <input type="text" name="dates" id="id_dates" required readonly style="cursor:pointer;">
      <div id="selected-dates"></div> <!-- é¸æŠã•ã‚ŒãŸæ—¥ä»˜ã‚’è¡¨ç¤º -->
    </div>

    <!-- è¡ŒããŸã„ãƒªã‚¹ãƒˆã®ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal-body">
      <ul>
         {% if user_wanted_spots %}
            {% for spot in user_wanted_spots %}
               <li id="spot-{{ spot.id }}">
                  {% if spot.picture %}
                     <img src="{{ spot.picture.url }}" alt="{{ spot.spot_name }}" style="width:100px;height:auto;">
                  {% else %}
                     <img src="/static/default-image.jpg" alt="No image available" style="width:100px;height:auto;">
                  {% endif %}
                  <span class="spot-name">{{ spot.spot_name }}</span>
                  <button type="button" class="btn btn-success" onclick="addSpotToPlan('{{ spot.id }}')">è¿½åŠ </button>
               </li>
            {% endfor %}
         {% else %}
            <li>è¡ŒããŸã„ãƒªã‚¹ãƒˆã«ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ã‚¹ãƒãƒƒãƒˆã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</li>
         {% endif %}
      </ul>
   </div>

    <!-- è¦³å…‰åœ°æ¤œç´¢ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal" id="search-touristspot-modal">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h4 class="modal-title">è¦³å…‰åœ°æ¤œç´¢</h4>
            <button type="button" class="close" data-dismiss="modal">&times;</button>
          </div>
          <div class="modal-body">
            <form method="get" action="{% url 'travelapp:search_touristspot' %}">
              <input type="text" name="search" placeholder="è¦³å…‰åœ°ã‚’æ¤œç´¢" required>
              <button type="submit" class="btn btn-primary">æ¤œç´¢</button>
            </form>
            <div id="search-results">
              <!-- æ¤œç´¢çµæœã‚’è¡¨ç¤º -->
            </div>
          </div>
        </div>
      </div>
    </div>

  </form>

  <div id="selected-spots">
    <!-- è¿½åŠ ã•ã‚ŒãŸè¦³å…‰åœ° -->
  </div>

  <!-- åå‰ã‚’ã¤ã‘ã¦ä¿å­˜ -->
  <div id="save-section" style="display:none;">
    <label for="plan-name">ãƒ—ãƒ©ãƒ³ã®åå‰ã‚’ã¤ã‘ã¦ãã ã•ã„</label>
    <input type="text" name="plan-name" id="plan-name">
    <button onclick="savePlan()" class="btn btn-primary">ä¿å­˜</button>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const calendarInput = document.getElementById("id_dates");
      const calendarIcon = document.getElementById("calendar-icon");
      const selectedDatesContainer = document.getElementById("selected-dates");
      const saveSection = document.getElementById("save-section");
  
      let selectedDates = [];
  
      // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã¨ãã«ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’è¡¨ç¤º
      calendarIcon.addEventListener("click", function() {
        calendarInput.focus();  // inputãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
      });
  
      flatpickr(calendarInput, {
        mode: "multiple",
        dateFormat: "Y-m-d",
        minDate: "today",  // ä»Šæ—¥ä»¥é™ã®æ—¥ä»˜ã®ã¿é¸æŠå¯èƒ½
        maxItems: 5,  // æœ€å¤§5æ—¥é–“
        onChange: function (selectedDatesArray, dateStr, instance) {
          selectedDates = selectedDatesArray;
          displaySelectedDates(selectedDates);
          toggleSaveSection();
        }
      });
  
      function displaySelectedDates(dates) {
        // æ—¥ä»˜ã®é¸æŠçµæœã‚’ãƒ†ãƒ¼ãƒ–ãƒ«å½¢å¼ã§è¡¨ç¤º
        selectedDatesContainer.innerHTML = '';
        if (dates.length === 0) return;
  
        let tableHtml = '<table class="table">';
        tableHtml += '<thead><tr>';
        
        // æ—¥ä»˜ã®åˆ—ã‚’è¡¨ç¤º
        dates.forEach((date, index) => {
          if (index % 5 === 0 && index > 0) {
            tableHtml += '</tr><tr>';  // æ–°ã—ã„è¡Œã«åˆ‡ã‚Šæ›¿ãˆ
          }
          const formattedDate = formatDate(date);  // æ—¥ä»˜ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
          tableHtml += `
            <td>
              <div>${formattedDate}</div>
              <button type="button" class="btn btn-info" onclick="openLinkB()">æ—…è¡Œæ¤œç´¢ã‹ã‚‰é¸æŠ</button>
              <button type="button" class="btn btn-info" onclick="openLinkA()">è¡ŒããŸã„ãƒªã‚¹ãƒˆã‹ã‚‰é¸æŠ</button>
            </td>`;
        });
        tableHtml += '</tr></thead>';
        tableHtml += '</table>';
        selectedDatesContainer.innerHTML = tableHtml;
      }
  
      function toggleSaveSection() {
        if (selectedDates.length > 0) {
          saveSection.style.display = 'inline-block';
        }
      }
  
      // æ—¥ä»˜ã‚’æ—¥æœ¬èªå½¢å¼ã§ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
      function formatDate(date) {
        const d = new Date(date);
        const options = { 
          weekday: 'short', // æ›œæ—¥ï¼ˆä¾‹ï¼šæœˆã€ç«ã€æ°´...ï¼‰
          year: 'numeric',  // å¹´ï¼ˆä¾‹ï¼š2025ï¼‰
          month: '2-digit', // æœˆï¼ˆä¾‹ï¼š03ï¼‰
          day: '2-digit'    // æ—¥ï¼ˆä¾‹ï¼š20ï¼‰
        };
        return d.toLocaleDateString('ja-JP', options); // æ—¥æœ¬èªå½¢å¼ã§æ—¥ä»˜ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
      }
  
      // è¡ŒããŸã„ãƒªã‚¹ãƒˆã®è¿½åŠ 
      window.addSpotToPlan = function(spotId) {
        const selectedSpot = document.getElementById('spot-' + spotId);
        const spotHtml = `
          <div class="spot-item" id="added-spot-${spotId}">
            <img src="${selectedSpot.querySelector('img').src}" alt="spot image">
            <span>${selectedSpot.querySelector('.spot-name').textContent}</span>
            <button class="btn btn-danger" onclick="removeSpot('${spotId}')">å‰Šé™¤</button>
          </div>
        `;
        document.getElementById('selected-spots').innerHTML += spotHtml;
      };
  
      window.removeSpot = function(spotId) {
        document.getElementById('added-spot-' + spotId).remove();
      };
  
      window.savePlan = function() {
        const planName = document.getElementById('plan-name').value;
        if (planName) {
          // ã‚µãƒ¼ãƒãƒ¼ã¸ãƒ—ãƒ©ãƒ³ã‚’ä¿å­˜ã™ã‚‹ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
          alert('æ—…è¡Œãƒ—ãƒ©ãƒ³ã‚’ä¿å­˜ã—ã¾ã—ãŸ: ' + planName);
        } else {
          alert('ãƒ—ãƒ©ãƒ³ã®åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        }
      };
  
      // ãƒªãƒ³ã‚¯bã®è¡¨ç¤ºã‚¢ã‚¯ã‚·ãƒ§ãƒ³
      window.openLinkB = function() {
        $('#search-touristspot-modal').modal('show');
      };
  
      // ãƒªãƒ³ã‚¯aã®è¡¨ç¤ºã‚¢ã‚¯ã‚·ãƒ§ãƒ³
      window.openLinkA = function() {
        $('#wanted-spots-modal').modal('show');
      };
    });
  </script>
  

{% endblock %}
