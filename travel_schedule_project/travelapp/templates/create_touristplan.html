{% extends 'base.html' %}

{% block content %}
<h2>スケジュール内容を確認</h2>
<p>開始日: {{ start_date }}</p>
<p>終了日: {{ end_date }}</p>
<p>訪問日程:</p>
<ul>
  {% for date in visit_dates %}
    <li>{{ date }}</li>
  {% endfor %}
</ul>

<!-- フォーム -->
<form method="post">
  {% csrf_token %}
  {{ form.as_p }}

  <!-- 日付データをhiddenで渡す -->
  {% for date in visit_dates %}
    <input type="hidden" name="selected_dates" value="{{ date }}">
  {% endfor %}

  <!-- モーダルを開くボタン -->
  <button type="button" onclick="openModal()">行きたいリストから選択</button>

  <!-- 選択済みのスポットIDを保持 -->
  <div id="selected-spots"></div>

  <button type="submit">保存</button>
</form>

<!-- モーダル -->
<div id="modal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeModal()">&times;</span>
    <h3>行きたいリスト</h3>
    <form id="modal-form">
      {% for spot in user_wanted_spots %}
      <div>
        <input type="checkbox" id="spot_{{ spot.id }}" value="{{ spot.id }}" class="spot-checkbox">
        <label for="spot_{{ spot.id }}">{{ spot.spot_name }}</label>
      </div>
      {% endfor %}
      <button type="button" onclick="selectSpots()">確定</button>
    </form>
  </div>
</div>

<!-- CSS -->
<style>
  .modal {
    display: none;
    position: fixed;
    z-index: 1;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.4);
  }
  
  .modal-content {
    background-color: #fefefe;
    margin: 10% auto;
    padding: 20px;
    width: 80%;
    border-radius: 8px;
    box-shadow: 0px 4px 8px rgba(0,0,0,0.2);
  }
  
  .close {
    float: right;
    font-size: 28px;
    cursor: pointer;
  }
</style>

<!-- JavaScript -->
<script>
  // モーダルを開く
  function openModal() {
    document.getElementById('modal').style.display = 'block';
  }

  // モーダルを閉じる
  function closeModal() {
    document.getElementById('modal').style.display = 'none';
  }

  // 選択したスポットをフォームに追加
  function selectSpots() {
    const checkboxes = document.querySelectorAll('.spot-checkbox:checked');
    const selectedSpotsContainer = document.getElementById('selected-spots');
    
    // すでにある選択済みデータをクリア
    selectedSpotsContainer.innerHTML = '';

    checkboxes.forEach(checkbox => {
      // hidden input を作成してフォームに渡す
      const input = document.createElement('input');
      input.type = 'hidden';
      input.name = 'tourist_spots';
      input.value = checkbox.value;
      selectedSpotsContainer.appendChild(input);

      // 表示用に選択済みの観光地をリスト化
      const label = document.createElement('div');
      label.innerText = checkbox.nextElementSibling.innerText;
      selectedSpotsContainer.appendChild(label);
    });

    closeModal(); // モーダルを閉じる
  }
</script>

{% endblock %}





{% comment %} {% block content %}
<h1>旅行プラン作成</h1>
<form method="post">
  {% csrf_token %}
  {{ form.as_p }}
  
  <div id="calendar">
    <label for="dates">旅行日程選択（最大5日間）</label>
    <span id="calendar-icon" style="cursor:pointer;">📅</span>
    <input type="text" name="dates" id="id_dates" required readonly style="cursor:pointer;">
    <div id="selected-dates"></div>
  </div>

  <!-- 旅行日程ごとの観光地 -->
  <div id="tourist-spot-list">
    {% for date in selected_dates %}
      <div>
        <h3>{{ date }}</h3>
        <ul id="spot-list-{{ date }}">
          <!-- JSで追加される観光地リスト -->
        </ul>
      </div>
    {% endfor %}
  </div>

</form>

<div id="save-section" style="display:none;">
  <label for="plan-name">プランの名前をつけてください</label>
  <input type="text" name="plan-name" id="plan-name">
  <button onclick="savePlan()" class="btn btn-primary">保存</button>
</div>

<!-- JS部分 -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const calendarInput = document.getElementById("id_dates");
    const calendarIcon = document.getElementById("calendar-icon");
    const selectedDatesContainer = document.getElementById("selected-dates");
    const saveSection = document.getElementById("save-section");

    let selectedDates = [];

    // カレンダーアイコンをクリックで日付選択を開く
    calendarIcon.addEventListener("click", function() {
      calendarInput.focus();
    });

    // Flatpickrで日付を選択
    flatpickr(calendarInput, {
      mode: "multiple",
      dateFormat: "Y-m-d",
      minDate: "today",
      maxItems: 5,
      onChange: function (selectedDatesArray) {
        selectedDates = selectedDatesArray;
        displaySelectedDates(selectedDates);
        toggleSaveSection();
      }
    });

    // 選択した日付を表示
    function displaySelectedDates(dates) {
      selectedDatesContainer.innerHTML = '';
      if (dates.length === 0) return;

      let tableHtml = '<table class="table">';
      tableHtml += '<thead><tr>';
      dates.forEach((date, index) => {
        if (index % 5 === 0 && index > 0) {
          tableHtml += '</tr><tr>';
        }
        const formattedDate = formatDate(date);
        tableHtml += `
          <td>
            <div>${formattedDate}</div>
            <button type="button" class="btn btn-info" onclick="openLinkB()">旅行検索から選択</button>
            <button type="button" class="btn btn-info" onclick="openLinkA()">行きたいリストから選択</button>
          </td>`;
      });
      tableHtml += '</tr></thead></table>';
      selectedDatesContainer.innerHTML = tableHtml;
    }

    // 追加する観光地の処理
    document.addEventListener('click', function(event) {
      if (event.target.classList.contains('add-spot')) {
        const spotId = event.target.getAttribute('data-spot-id');
        const spotName = event.target.previousElementSibling.textContent;
        const visitDate = prompt('訪問日を選択してください (YYYY-MM-DD):');

        if (visitDate && selectedDates.includes(visitDate)) {
          const targetList = document.getElementById(`spot-list-${visitDate}`);
          if (targetList) {
            const li = document.createElement('li');
            li.textContent = spotName;
            targetList.appendChild(li);

            // フォームにデータを追加
            const form = document.createElement('input');
            form.type = 'hidden';
            form.name = 'tourist_spots';
            form.value = spotId;
            document.forms[0].appendChild(form);

            const dateInput = document.createElement('input');
            dateInput.type = 'hidden';
            dateInput.name = 'selected_dates';
            dateInput.value = visitDate;
            document.forms[0].appendChild(dateInput);
          }
        }
      }
    });

    // 保存セクションを表示
    function toggleSaveSection() {
      if (selectedDates.length > 0) {
        saveSection.style.display = 'inline-block';
      }
    }

    // 日付をフォーマット
    function formatDate(date) {
      const d = new Date(date);
      const options = { 
        weekday: 'short', 
        year: 'numeric',
        month: '2-digit',
        day: '2-digit'  
      };
      return d.toLocaleDateString('ja-JP', options);
    }

    // 旅行プランを保存
    window.savePlan = function() {
      const planName = document.getElementById('plan-name').value;
      if (planName) {
        alert('旅行プランを保存しました: ' + planName);
      } else {
        alert('プランの名前を入力してください');
      }
    };

    // 旅行検索モーダルを開く
    window.openLinkB = function() {
      $('#search-touristspot-modal').modal('show');
    };

    // 行きたいリストモーダルを開く
    window.openLinkA = function() {
      $('#wanted-spot-modal').modal('show');
    };
  });
</script>

<!-- 観光地検索モーダル -->
{% include 'modal_search_touristspot.html' %}

<!-- 行きたいリストモーダル -->
{% include 'modal_wanted_spot.html' %}

{% endblock %}
 {% endcomment %}
