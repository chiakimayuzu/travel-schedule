{% extends "base.html" %}

{% block content %}
  <h1>旅行プラン作成</h1>
  <form method="post">
    {% csrf_token %}
    {{ form.as_p }}
    <div id="calendar">
      <label for="dates">旅行日程選択（最大5日間）</label>
      <span id="calendar-icon" style="cursor:pointer;">📅</span>
      <input type="text" name="dates" id="id_dates" required readonly style="cursor:pointer;">
      <div id="selected-dates"></div>
    </div>

    <!-- 旅行日程ごとの観光地 -->
    {% for date, spots in spots_by_date.items %}
      <div class="date-section" id="spots-for-date-{{ date }}">
        <h4>{{ date }}</h4>
        <div class="spots-for-date">
          {% for spot in spots %}
            <div class="spot-item" id="spot-{{ spot.id }}">
              <img src="{{ spot.image.url }}" alt="{{ spot.name }}">
              <span>{{ spot.name }}</span>
              <button type="button" class="btn btn-info" onclick="addSpotToPlan({{ spot.id }})">追加</button>
            </div>
          {% endfor %}
        </div>
      </div>
    {% endfor %}
    
    <button type="submit" class="btn btn-primary">保存</button>
  </form>

  <div id="selected-spots">
    <!-- 追加された観光地 -->
  </div>

  <div id="save-section" style="display:none;">
    <label for="plan-name">プランの名前をつけてください</label>
    <input type="text" name="plan-name" id="plan-name">
    <button onclick="savePlan()" class="btn btn-primary">保存</button>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const calendarInput = document.getElementById("id_dates");
      const calendarIcon = document.getElementById("calendar-icon");
      const selectedDatesContainer = document.getElementById("selected-dates");
      const saveSection = document.getElementById("save-section");

      let selectedDates = [];

      calendarIcon.addEventListener("click", function() {
        calendarInput.focus();
      });

      flatpickr(calendarInput, {
        mode: "multiple",
        dateFormat: "Y-m-d",
        minDate: "today",
        maxItems: 5,
        onChange: function (selectedDatesArray, dateStr, instance) {
          selectedDates = selectedDatesArray;
          displaySelectedDates(selectedDates);
          toggleSaveSection();
        }
      });

      function displaySelectedDates(dates) {
        selectedDatesContainer.innerHTML = '';
        if (dates.length === 0) return;

        let tableHtml = '<table class="table">';
        tableHtml += '<thead><tr>';
        dates.forEach((date, index) => {
          if (index % 5 === 0 && index > 0) {
            tableHtml += '</tr><tr>';
          }
          const formattedDate = formatDate(date);
          tableHtml += `
            <td>
              <div>${formattedDate}</div>
              <button type="button" class="btn btn-info" onclick="openLinkB()">旅行検索から選択</button>
              <button type="button" class="btn btn-info" onclick="openLinkA()">行きたいリストから選択</button>
            </td>`;
        });
        tableHtml += '</tr></thead>';
        tableHtml += '</table>';
        selectedDatesContainer.innerHTML = tableHtml;
      }

      function toggleSaveSection() {
        if (selectedDates.length > 0) {
          saveSection.style.display = 'inline-block';
        }
      }

      function formatDate(date) {
        const d = new Date(date);
        const options = { 
          weekday: 'short', 
          year: 'numeric',
          month: '2-digit',
          day: '2-digit'  
        };
        return d.toLocaleDateString('ja-JP', options);
      }

      window.addSpotToPlan = function(spotId) {
        const selectedSpot = document.getElementById('spot-' + spotId);
        const spotHtml = `
          <div class="spot-item" id="added-spot-${spotId}">
            <img src="${selectedSpot.querySelector('img').src}" alt="spot image">
            <span>${selectedSpot.querySelector('.spot-name').textContent}</span>
            <button class="btn btn-danger" onclick="removeSpot('${spotId}')">削除</button>
          </div>`;
        document.getElementById('selected-spots').innerHTML += spotHtml;
      };

      window.removeSpot = function(spotId) {
        document.getElementById('added-spot-' + spotId).remove();
      };

      window.savePlan = function() {
        const planName = document.getElementById('plan-name').value;
        if (planName) {
          alert('旅行プランを保存しました: ' + planName);
        } else {
          alert('プランの名前を入力してください');
        }
      };

      window.openLinkB = function() {
        $('#search-touristspot-modal').modal('show');
      };

      window.openLinkA = function() {
        $('#wanted-spot-modal').modal('show');
      };
    });
  </script>

  <!-- 観光地検索モーダル -->
  {% include 'modal_search_touristspot.html' %}

  <!-- 行きたいリストモーダル -->
  {% include 'modal_wanted_spot.html' %}
{% endblock %}

<style>
  .spot-item img {
    width: 100%; /* 横幅を親要素に合わせて調整 */
    height: auto; /* 高さは自動で調整 */
    max-width: 50px; /* 最大幅を設定（必要に応じて調整） */
    max-height: 50px; /* 最大高さを設定（必要に応じて調整） */
    object-fit: cover; /* 画像が親要素内に収まるように調整 */
  }

  .spot-item {
    text-align: center;
    margin-bottom: 15px;
  }

  .spot-item button {
    margin-top: 5px;
  }
</style>