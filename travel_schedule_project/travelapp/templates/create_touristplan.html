{% extends 'base.html' %}

{% block content %}
<h2>ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å†…å®¹ã‚’ç¢ºèª</h2>
<p>é–‹å§‹æ—¥: {{ start_date }}</p>
<p>çµ‚äº†æ—¥: {{ end_date }}</p>
<p>è¨ªå•æ—¥ç¨‹:</p>
<ul>
  {% for date in visit_dates %}
    <li>{{ date }}</li>
  {% endfor %}
</ul>

<!-- ãƒ•ã‚©ãƒ¼ãƒ  -->
<form method="post">
  {% csrf_token %}
  {{ form.as_p }}

  <!-- æ—¥ä»˜ãƒ‡ãƒ¼ã‚¿ã‚’hiddenã§æ¸¡ã™ -->
  {% for date in visit_dates %}
    <input type="hidden" name="selected_dates" value="{{ date }}">
  {% endfor %}

  <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ããƒœã‚¿ãƒ³ -->
  <button type="button" onclick="openModal()">è¡ŒããŸã„ãƒªã‚¹ãƒˆã‹ã‚‰é¸æŠ</button>

  <!-- é¸æŠæ¸ˆã¿ã®ã‚¹ãƒãƒƒãƒˆIDã‚’ä¿æŒ -->
  <div id="selected-spots"></div>

  <button type="submit">ä¿å­˜</button>
</form>

<!-- ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="modal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeModal()">&times;</span>
    <h3>è¡ŒããŸã„ãƒªã‚¹ãƒˆ</h3>
    <form id="modal-form">
      {% for spot in user_wanted_spots %}
      <div>
        <input type="checkbox" id="spot_{{ spot.id }}" value="{{ spot.id }}" class="spot-checkbox">
        <label for="spot_{{ spot.id }}">{{ spot.spot_name }}</label>
      </div>
      {% endfor %}
      <button type="button" onclick="selectSpots()">ç¢ºå®š</button>
    </form>
  </div>
</div>

<!-- CSS -->
<style>
  .modal {
    display: none;
    position: fixed;
    z-index: 1;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.4);
  }
  
  .modal-content {
    background-color: #fefefe;
    margin: 10% auto;
    padding: 20px;
    width: 80%;
    border-radius: 8px;
    box-shadow: 0px 4px 8px rgba(0,0,0,0.2);
  }
  
  .close {
    float: right;
    font-size: 28px;
    cursor: pointer;
  }
</style>

<!-- JavaScript -->
<script>
  // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
  function openModal() {
    document.getElementById('modal').style.display = 'block';
  }

  // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
  function closeModal() {
    document.getElementById('modal').style.display = 'none';
  }

  // é¸æŠã—ãŸã‚¹ãƒãƒƒãƒˆã‚’ãƒ•ã‚©ãƒ¼ãƒ ã«è¿½åŠ 
  function selectSpots() {
    const checkboxes = document.querySelectorAll('.spot-checkbox:checked');
    const selectedSpotsContainer = document.getElementById('selected-spots');
    
    // ã™ã§ã«ã‚ã‚‹é¸æŠæ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢
    selectedSpotsContainer.innerHTML = '';

    checkboxes.forEach(checkbox => {
      // hidden input ã‚’ä½œæˆã—ã¦ãƒ•ã‚©ãƒ¼ãƒ ã«æ¸¡ã™
      const input = document.createElement('input');
      input.type = 'hidden';
      input.name = 'tourist_spots';
      input.value = checkbox.value;
      selectedSpotsContainer.appendChild(input);

      // è¡¨ç¤ºç”¨ã«é¸æŠæ¸ˆã¿ã®è¦³å…‰åœ°ã‚’ãƒªã‚¹ãƒˆåŒ–
      const label = document.createElement('div');
      label.innerText = checkbox.nextElementSibling.innerText;
      selectedSpotsContainer.appendChild(label);
    });

    closeModal(); // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
  }
</script>

{% endblock %}





{% comment %} {% block content %}
<h1>æ—…è¡Œãƒ—ãƒ©ãƒ³ä½œæˆ</h1>
<form method="post">
  {% csrf_token %}
  {{ form.as_p }}
  
  <div id="calendar">
    <label for="dates">æ—…è¡Œæ—¥ç¨‹é¸æŠï¼ˆæœ€å¤§5æ—¥é–“ï¼‰</label>
    <span id="calendar-icon" style="cursor:pointer;">ğŸ“…</span>
    <input type="text" name="dates" id="id_dates" required readonly style="cursor:pointer;">
    <div id="selected-dates"></div>
  </div>

  <!-- æ—…è¡Œæ—¥ç¨‹ã”ã¨ã®è¦³å…‰åœ° -->
  <div id="tourist-spot-list">
    {% for date in selected_dates %}
      <div>
        <h3>{{ date }}</h3>
        <ul id="spot-list-{{ date }}">
          <!-- JSã§è¿½åŠ ã•ã‚Œã‚‹è¦³å…‰åœ°ãƒªã‚¹ãƒˆ -->
        </ul>
      </div>
    {% endfor %}
  </div>

</form>

<div id="save-section" style="display:none;">
  <label for="plan-name">ãƒ—ãƒ©ãƒ³ã®åå‰ã‚’ã¤ã‘ã¦ãã ã•ã„</label>
  <input type="text" name="plan-name" id="plan-name">
  <button onclick="savePlan()" class="btn btn-primary">ä¿å­˜</button>
</div>

<!-- JSéƒ¨åˆ† -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const calendarInput = document.getElementById("id_dates");
    const calendarIcon = document.getElementById("calendar-icon");
    const selectedDatesContainer = document.getElementById("selected-dates");
    const saveSection = document.getElementById("save-section");

    let selectedDates = [];

    // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã§æ—¥ä»˜é¸æŠã‚’é–‹ã
    calendarIcon.addEventListener("click", function() {
      calendarInput.focus();
    });

    // Flatpickrã§æ—¥ä»˜ã‚’é¸æŠ
    flatpickr(calendarInput, {
      mode: "multiple",
      dateFormat: "Y-m-d",
      minDate: "today",
      maxItems: 5,
      onChange: function (selectedDatesArray) {
        selectedDates = selectedDatesArray;
        displaySelectedDates(selectedDates);
        toggleSaveSection();
      }
    });

    // é¸æŠã—ãŸæ—¥ä»˜ã‚’è¡¨ç¤º
    function displaySelectedDates(dates) {
      selectedDatesContainer.innerHTML = '';
      if (dates.length === 0) return;

      let tableHtml = '<table class="table">';
      tableHtml += '<thead><tr>';
      dates.forEach((date, index) => {
        if (index % 5 === 0 && index > 0) {
          tableHtml += '</tr><tr>';
        }
        const formattedDate = formatDate(date);
        tableHtml += `
          <td>
            <div>${formattedDate}</div>
            <button type="button" class="btn btn-info" onclick="openLinkB()">æ—…è¡Œæ¤œç´¢ã‹ã‚‰é¸æŠ</button>
            <button type="button" class="btn btn-info" onclick="openLinkA()">è¡ŒããŸã„ãƒªã‚¹ãƒˆã‹ã‚‰é¸æŠ</button>
          </td>`;
      });
      tableHtml += '</tr></thead></table>';
      selectedDatesContainer.innerHTML = tableHtml;
    }

    // è¿½åŠ ã™ã‚‹è¦³å…‰åœ°ã®å‡¦ç†
    document.addEventListener('click', function(event) {
      if (event.target.classList.contains('add-spot')) {
        const spotId = event.target.getAttribute('data-spot-id');
        const spotName = event.target.previousElementSibling.textContent;
        const visitDate = prompt('è¨ªå•æ—¥ã‚’é¸æŠã—ã¦ãã ã•ã„ (YYYY-MM-DD):');

        if (visitDate && selectedDates.includes(visitDate)) {
          const targetList = document.getElementById(`spot-list-${visitDate}`);
          if (targetList) {
            const li = document.createElement('li');
            li.textContent = spotName;
            targetList.appendChild(li);

            // ãƒ•ã‚©ãƒ¼ãƒ ã«ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ 
            const form = document.createElement('input');
            form.type = 'hidden';
            form.name = 'tourist_spots';
            form.value = spotId;
            document.forms[0].appendChild(form);

            const dateInput = document.createElement('input');
            dateInput.type = 'hidden';
            dateInput.name = 'selected_dates';
            dateInput.value = visitDate;
            document.forms[0].appendChild(dateInput);
          }
        }
      }
    });

    // ä¿å­˜ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
    function toggleSaveSection() {
      if (selectedDates.length > 0) {
        saveSection.style.display = 'inline-block';
      }
    }

    // æ—¥ä»˜ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
    function formatDate(date) {
      const d = new Date(date);
      const options = { 
        weekday: 'short', 
        year: 'numeric',
        month: '2-digit',
        day: '2-digit'  
      };
      return d.toLocaleDateString('ja-JP', options);
    }

    // æ—…è¡Œãƒ—ãƒ©ãƒ³ã‚’ä¿å­˜
    window.savePlan = function() {
      const planName = document.getElementById('plan-name').value;
      if (planName) {
        alert('æ—…è¡Œãƒ—ãƒ©ãƒ³ã‚’ä¿å­˜ã—ã¾ã—ãŸ: ' + planName);
      } else {
        alert('ãƒ—ãƒ©ãƒ³ã®åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      }
    };

    // æ—…è¡Œæ¤œç´¢ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
    window.openLinkB = function() {
      $('#search-touristspot-modal').modal('show');
    };

    // è¡ŒããŸã„ãƒªã‚¹ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
    window.openLinkA = function() {
      $('#wanted-spot-modal').modal('show');
    };
  });
</script>

<!-- è¦³å…‰åœ°æ¤œç´¢ãƒ¢ãƒ¼ãƒ€ãƒ« -->
{% include 'modal_search_touristspot.html' %}

<!-- è¡ŒããŸã„ãƒªã‚¹ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
{% include 'modal_wanted_spot.html' %}

{% endblock %}
 {% endcomment %}
