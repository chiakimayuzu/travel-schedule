{% extends 'base.html' %}

{% block content %}
<h2>スケジュール内容を確認</h2>
<p>開始日: <span id="start_date">{{ start_date }}</span></p>
<p>終了日: <span id="end_date">{{ end_date }}</span></p>
<p>訪問日程:</p>
<ul id="visit_dates_list"></ul>

<!-- フォーム -->
<form method="post">
  {% csrf_token %}

  <!-- 計算した日付データを hidden で渡す -->
  <div id="hidden_dates"></div>

  <!-- モーダルを開くボタン -->
  <button type="button" onclick="openModal()">行きたいリストから選択</button>

  <!-- 選択済みのスポットIDを保持 -->
  <div id="selected-spots"></div>

  <button type="submit">保存</button>
</form>

<!-- モーダル -->
<div id="modal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeModal()">&times;</span>
    <h3>行きたいリスト</h3>
    <form id="modal-form">
      {% for spot in user_wanted_spots %}
      <div>
        <input type="checkbox" id="spot_{{ spot.id }}" value="{{ spot.id }}" class="spot-checkbox">
        <label for="spot_{{ spot.id }}">{{ spot.spot_name }}</label>
        
        <!-- 日付選択 -->
        <select name="visit_date_{{ spot.id }}" class="visit-date-select">
          {% for date in visit_dates %}
            <option value="{{ date }}">{{ date }}</option>
          {% endfor %}
        </select>
      </div>
      {% endfor %}
      <button type="button" onclick="selectSpots()">確定</button>
    </form>
  </div>
</div>

<!-- CSS -->
<style>
  .modal {
    display: none;
    position: fixed;
    z-index: 1;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.4);
  }
  
  .modal-content {
    background-color: #fefefe;
    margin: 10% auto;
    padding: 20px;
    width: 80%;
    border-radius: 8px;
    box-shadow: 0px 4px 8px rgba(0,0,0,0.2);
  }
  
  .close {
    float: right;
    font-size: 28px;
    cursor: pointer;
  }
</style>

<!-- JavaScript -->
<script>
  // モーダルを開く
  function openModal() {
    document.getElementById('modal').style.display = 'block';
  }

  // モーダルを閉じる
  function closeModal() {
    document.getElementById('modal').style.display = 'none';
  }

  // 選択したスポットをフォームに追加
  function selectSpots() {
    const checkboxes = document.querySelectorAll('.spot-checkbox:checked');
    const selectedSpotsContainer = document.getElementById('selected-spots');
    
    // すでにある選択済みデータをクリア
    selectedSpotsContainer.innerHTML = '';

    checkboxes.forEach(checkbox => {
      const spotId = checkbox.value;
      const visitDate = document.querySelector(`select[name="visit_date_${spotId}"]`).value;

      // hidden input を作成してフォームに渡す
      const input = document.createElement('input');
      input.type = 'hidden';
      input.name = 'tourist_spots';
      input.value = spotId;
      selectedSpotsContainer.appendChild(input);

      const dateInput = document.createElement('input');
      dateInput.type = 'hidden';
      dateInput.name = 'selected_dates';
      dateInput.value = visitDate;
      selectedSpotsContainer.appendChild(dateInput);

      // 表示用に選択済みの観光地をリスト化
      const label = document.createElement('div');
      label.innerText = checkbox.nextElementSibling.innerText + " - " + visitDate;
      selectedSpotsContainer.appendChild(label);
    });

    closeModal(); // モーダルを閉じる
  }
</script>



<script>
  document.addEventListener("DOMContentLoaded", function () {
      let startDateElement = document.getElementById("start_date");
      let endDateElement = document.getElementById("end_date");

      let startDateStr = startDateElement.textContent;
      let endDateStr = endDateElement.textContent;

      if (startDateStr && endDateStr) {
          let startDate = new Date(startDateStr);
          let endDate = new Date(endDateStr);
          let visitDatesList = document.getElementById("visit_dates_list");
          let hiddenDatesDiv = document.getElementById("hidden_dates");

          // 曜日を取得する関数
          function formatDateWithDay(date) {
              let year = date.getFullYear();
              let month = date.getMonth() + 1;  // 月は0始まりなので+1
              let day = date.getDate();
              let daysOfWeek = ["日", "月", "火", "水", "木", "金", "土"];
              let dayOfWeek = daysOfWeek[date.getDay()];
              return `${year}/${month}/${day} (${dayOfWeek})`;
          }

          // start_dateとend_dateの表示を変換
          startDateElement.textContent = formatDateWithDay(startDate);
          endDateElement.textContent = formatDateWithDay(endDate);

          while (startDate <= endDate) {
              let formattedDate = formatDateWithDay(startDate);

              // リストに表示
              let li = document.createElement("li");
              li.textContent = formattedDate;
              visitDatesList.appendChild(li);

              // hidden input に追加（フォーム送信用、YYYY-MM-DD 形式で送る）
              let hiddenInput = document.createElement("input");
              hiddenInput.type = "hidden";
              hiddenInput.name = "selected_dates";
              hiddenInput.value = startDate.toISOString().split('T')[0];  // YYYY-MM-DD形式
              hiddenDatesDiv.appendChild(hiddenInput);

              // 1日加算
              startDate.setDate(startDate.getDate() + 1);
          }
      }
  });
</script>
{% endblock %}