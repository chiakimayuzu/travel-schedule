{% extends "base.html" %}

{% block content %}
<h1>æ—…è¡Œãƒ—ãƒ©ãƒ³ä½œæˆ</h1>
<form method="post">
  {% csrf_token %}
  {{ form.as_p }}
  
  <div id="calendar">
    <label for="dates">æ—…è¡Œæ—¥ç¨‹é¸æŠï¼ˆæœ€å¤§5æ—¥é–“ï¼‰</label>
    <span id="calendar-icon" style="cursor:pointer;">ğŸ“…</span>
    <input type="text" name="dates" id="id_dates" required readonly style="cursor:pointer;">
    <div id="selected-dates"></div>
  </div>

  <!-- æ—…è¡Œæ—¥ç¨‹ã”ã¨ã®è¦³å…‰åœ° -->
  <div id="tourist-spot-list">
    {% for date in selected_dates %}
      <div>
        <h3>{{ date }}</h3>
        <ul id="spot-list-{{ date }}">
          <!-- JSã§è¿½åŠ ã•ã‚Œã‚‹è¦³å…‰åœ°ãƒªã‚¹ãƒˆ -->
        </ul>
      </div>
    {% endfor %}
  </div>


</form>

<div id="save-section" style="display:none;">
  <label for="plan-name">ãƒ—ãƒ©ãƒ³ã®åå‰ã‚’ã¤ã‘ã¦ãã ã•ã„</label>
  <input type="text" name="plan-name" id="plan-name">
  <button onclick="savePlan()" class="btn btn-primary">ä¿å­˜</button>
</div>

<!-- JSéƒ¨åˆ† -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const calendarInput = document.getElementById("id_dates");
    const calendarIcon = document.getElementById("calendar-icon");
    const selectedDatesContainer = document.getElementById("selected-dates");
    const saveSection = document.getElementById("save-section");

    let selectedDates = [];

    // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã§æ—¥ä»˜é¸æŠã‚’é–‹ã
    calendarIcon.addEventListener("click", function() {
      calendarInput.focus();
    });

    // Flatpickrã§æ—¥ä»˜ã‚’é¸æŠ
    flatpickr(calendarInput, {
      mode: "multiple",
      dateFormat: "Y-m-d",
      minDate: "today",
      maxItems: 5,
      onChange: function (selectedDatesArray) {
        selectedDates = selectedDatesArray;
        displaySelectedDates(selectedDates);
        toggleSaveSection();
      }
    });

    // é¸æŠã—ãŸæ—¥ä»˜ã‚’è¡¨ç¤º
    function displaySelectedDates(dates) {
      selectedDatesContainer.innerHTML = '';
      if (dates.length === 0) return;

      let tableHtml = '<table class="table">';
      tableHtml += '<thead><tr>';
      dates.forEach((date, index) => {
        if (index % 5 === 0 && index > 0) {
          tableHtml += '</tr><tr>';
        }
        const formattedDate = formatDate(date);
        tableHtml += `
          <td>
            <div>${formattedDate}</div>
            <button type="button" class="btn btn-info" onclick="openLinkB()">æ—…è¡Œæ¤œç´¢ã‹ã‚‰é¸æŠ</button>
            <button type="button" class="btn btn-info" onclick="openLinkA()">è¡ŒããŸã„ãƒªã‚¹ãƒˆã‹ã‚‰é¸æŠ</button>
          </td>`;
      });
      tableHtml += '</tr></thead></table>';
      selectedDatesContainer.innerHTML = tableHtml;
    }

    // è¿½åŠ ã™ã‚‹è¦³å…‰åœ°ã®å‡¦ç†
    document.addEventListener('click', function(event) {
      if (event.target.classList.contains('add-spot')) {
        const spotId = event.target.getAttribute('data-spot-id');
        const spotName = event.target.previousElementSibling.textContent;
        const visitDate = prompt('è¨ªå•æ—¥ã‚’é¸æŠã—ã¦ãã ã•ã„ (YYYY-MM-DD):');

        if (visitDate && selectedDates.includes(visitDate)) {
          const targetList = document.getElementById(`spot-list-${visitDate}`);
          if (targetList) {
            const li = document.createElement('li');
            li.textContent = spotName;
            targetList.appendChild(li);

            // ãƒ•ã‚©ãƒ¼ãƒ ã«ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ 
            const form = document.createElement('input');
            form.type = 'hidden';
            form.name = 'tourist_spots';
            form.value = spotId;
            document.forms[0].appendChild(form);

            const dateInput = document.createElement('input');
            dateInput.type = 'hidden';
            dateInput.name = 'selected_dates';
            dateInput.value = visitDate;
            document.forms[0].appendChild(dateInput);
          }
        }
      }
    });

    // ä¿å­˜ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
    function toggleSaveSection() {
      if (selectedDates.length > 0) {
        saveSection.style.display = 'inline-block';
      }
    }

    // æ—¥ä»˜ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
    function formatDate(date) {
      const d = new Date(date);
      const options = { 
        weekday: 'short', 
        year: 'numeric',
        month: '2-digit',
        day: '2-digit'  
      };
      return d.toLocaleDateString('ja-JP', options);
    }

    // æ—…è¡Œãƒ—ãƒ©ãƒ³ã‚’ä¿å­˜
    window.savePlan = function() {
      const planName = document.getElementById('plan-name').value;
      if (planName) {
        alert('æ—…è¡Œãƒ—ãƒ©ãƒ³ã‚’ä¿å­˜ã—ã¾ã—ãŸ: ' + planName);
      } else {
        alert('ãƒ—ãƒ©ãƒ³ã®åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      }
    };

    // æ—…è¡Œæ¤œç´¢ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
    window.openLinkB = function() {
      $('#search-touristspot-modal').modal('show');
    };

    // è¡ŒããŸã„ãƒªã‚¹ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
    window.openLinkA = function() {
      $('#wanted-spot-modal').modal('show');
    };
  });
</script>

<!-- è¦³å…‰åœ°æ¤œç´¢ãƒ¢ãƒ¼ãƒ€ãƒ« -->
{% include 'modal_search_touristspot.html' %}

<!-- è¡ŒããŸã„ãƒªã‚¹ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
{% include 'modal_wanted_spot.html' %}

{% endblock %}
